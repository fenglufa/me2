# AI 分身项目 - 服务架构与功能说明

## 🎯 MVP 核心目标

让用户第一次感受到:**一个自己的数字生命正在另一个世界生活**

---

## 📦 后端微服务架构详解

### 1. **API Gateway (网关服务)**
**职责:**
- 统一入口,所有客户端请求先到这里
- JWT 认证和鉴权
- 限流、熔断
- 路由转发到各个微服务
- A/B 测试分流

**技术:** go-zero API 服务

---

### 2. **SMS Service (短信服务)**
**职责:**
- 发送短信验证码
- 验证码校验
- 短信发送记录
- 防刷机制(频率限制)

**技术:**
- 阿里云短信服务 SDK

**核心 API:**
- `POST /sms/send` - 发送验证码
- `POST /sms/verify` - 验证验证码

---

### 3. **OSS Service (对象存储服务)**
**职责:**
- 生成客户端直传 OSS 的签名和凭证
- 管理文件上传策略(大小限制、格式限制)
- 图片 URL 管理
- 文件删除

**技术:**
- 阿里云 OSS SDK
- STS 临时授权

**核心 API:**
- `GET /oss/upload-token` - 获取上传凭证(客户端直传)
- `POST /oss/callback` - OSS 上传回调
- `DELETE /oss/file` - 删除文件

**使用场景:**
- 用户头像上传(客户端直传)
- AI 生成的事件图片存储(服务端上传)
- 分享海报图片存储

---

### 4. **User Service (用户服务)**
**职责:**
- 用户注册/登录(手机号+短信验证码)
- 用户账号基础信息管理
- 订阅状态管理(免费/付费会员)
- 用户偏好设置

**核心 API:**
- `POST /auth/send-code` - 发送验证码(调用 SMS Service)
- `POST /auth/login` - 手机号+验证码登录
- `GET /user/info` - 获取用户账号信息
- `PATCH /user/settings` - 更新设置(通知、隐私等)
- `GET /user/subscription` - 获取订阅状态

**登录流程:**
```
1. 客户端请求发送验证码 → SMS Service
2. 用户输入验证码 → User Service 验证
3. 验证通过 → 生成 JWT Token
4. 返回 Token 和用户信息
5. 检查是否有分身 → 没有则引导创建分身
```

**重要说明:**
- User 只管理账号信息(手机号、订阅状态)
- **不存储昵称和头像** (这些属于分身)
- 用户的展示身份 = 分身的名字和头像

---

### 5. **Avatar Service (分身服务) ⭐核心**
**职责:**
- 管理分身的所有属性和状态
- **6 维人格系统**:
  - 情绪温度 (Warmth ↔ Coolness) 0-100
  - 冒险倾向 (Adventurous ↔ Safe) 0-100
  - 人际能量 (Social ↔ Solitude) 0-100
  - 创造性 (Creative ↔ Structured) 0-100
  - 情绪稳定性 (Calm ↔ Sensitive) 0-100
  - 生活动力 (Energetic ↔ Gentle) 0-100
- 分身状态管理(能量、情绪、心境)
- 分身成长等级和经验值
- 与用户的关系进度(信任度、亲密度、共鸣度)
- 成长数据聚合和统计

**核心 API:**
- `POST /avatar/create` - 创建分身(设置名字、头像、初始性格)
- `GET /avatar/my` - 获取当前用户的分身
- `GET /avatar/{id}` - 获取分身详情
- `PATCH /avatar/{id}/profile` - 更新分身资料(名字、头像)
- `GET /avatar/{id}/personality` - 获取性格面板(6维曲线)
- `GET /avatar/{id}/growth` - 获取成长数据(等级、经验、里程碑)
- `GET /avatar/{id}/relationship` - 获取关系面板
- `GET /avatar/{id}/stats` - 获取统计数据(事件数、对话数等)
- `PATCH /avatar/{id}/state` - 更新状态(能量/情绪)
- `PATCH /avatar/{id}/personality` - 更新性格维度(事件触发)
- `POST /avatar/{id}/milestone` - 记录成长节点

**重要说明:**
- **分身的名字和头像就是用户在产品中的身份**
- MVP 阶段一个用户只能有一个分身
- 创建分身时需要上传头像(调用 OSS Service 获取上传凭证)
- 所有社交、展示、分享都使用分身的信息

**数据结构:**
```
avatar {
  id, user_id, name, avatar_url,

  // 6维人格
  warmth, adventurous, social,
  creative, calm, energetic,

  // 当前状态
  emotion_state, energy, mood,

  // 成长数据
  growth_level, experience,

  // 关系数据
  trust_score, intimacy_score, resonance_score,

  created_at, updated_at
}

avatar_milestones {
  id, avatar_id, milestone_type,
  achieved_at, description
}

avatar_stats {
  avatar_id,
  total_events, total_dialogues,
  total_travels, total_socials,
  regions_explored, days_active,
  updated_at
}
```

**成长数据来源:**
- 性格维度: 每次事件后由 Event Service 更新
- 成长等级: 根据经验值自动计算
- 关系分数: 对话、互动、日记等行为累积
- 统计数据: 定期从各服务聚合

---

### 6. **Action Service (行动逻辑服务) ⭐核心**
**职责:**
决定分身"什么时候做什么" - 分身的日常行为调度

**核心功能:**

#### a) 行动调度器 (Action Scheduler)
- 定时任务(每 2-6 小时触发一次行动窗口)
- 根据时间段分配行动倾向:
  - 清晨(6-10): 整理、思考、计划
  - 白天(10-14): 探索、学习、出行
  - 午后(14-18): 社交倾向提升
  - 夜间(18-22): 情绪事件、创作
  - 深夜(22-02): 休息、做梦

#### b) 行动意图计算 (Action Intent Calculator)
- 收集输入信号:
  - 时间段权重
  - 分身人格向量
  - 用户互动事件
  - 全局元宇宙事件
  - 随机因子
- 对行动类别打分:
  - 探索 Exploration
  - 社交 Social
  - 学习 Study
  - 创作 Creative
  - 休息 Rest
  - 游戏/娱乐 Play
  - 回应用户 Respond

#### c) 行为选择器 (Behavior Selector)
- 根据得分选择最终行为
- 考虑冷却时间避免重复
- 执行行动链(决定目的地 → 生成路径 → 触发事件)

**核心 API:**
- `POST /action/trigger` - 触发行动窗口
- `GET /action/{avatarId}/current` - 获取当前行动
- `GET /action/{avatarId}/schedule` - 获取行动计划

**工作流程:**
```
定时触发 → 收集信号 → 计算行动意图 → 选择行为
→ 调用 Event Service 生成对应事件
```

---

### 7. **Scheduler Service (调度服务) ⭐核心**
**职责:**
自动调度分身行为执行，实现分身的自主生活

**核心功能:**

#### a) 调度配置管理
- 为每个分身维护独立的调度配置
- 支持启用/暂停/禁用调度
- 记录调度历史和统计信息
- 管理调度间隔（2-6 小时随机）

#### b) 自动调度扫描
- 每 60 秒扫描一次数据库
- 查找到达调度时间的分身（`next_schedule_time <= now AND status = 'active'`）
- 并发控制（默认最多 10 个并发调度）
- 使用信号量避免系统过载

#### c) 调度执行
- 调用 Action Service 的 ScheduleAction 接口
- 根据执行结果更新调度配置
- 成功：计算下次调度时间（2-6 小时随机）
- 失败：5 分钟后重试，连续失败 5 次自动暂停

#### d) 失败重试机制
- 调度失败后自动延迟 5 分钟重试
- 记录失败次数
- 连续失败 5 次自动暂停调度（需手动恢复）
- 成功后重置失败计数

**核心 API:**
- `POST /scheduler/enable` - 启用分身调度
- `POST /scheduler/pause` - 暂停分身调度
- `POST /scheduler/resume` - 恢复分身调度
- `GET /scheduler/status/{avatarId}` - 查询调度状态
- `POST /scheduler/trigger` - 手动触发调度
- `POST /scheduler/batch-status` - 批量查询调度状态

**数据表结构:**
```sql
CREATE TABLE avatar_schedules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    avatar_id BIGINT NOT NULL UNIQUE,
    status ENUM('active', 'paused', 'disabled') DEFAULT 'active',
    next_schedule_time DATETIME NOT NULL,
    last_schedule_time DATETIME DEFAULT NULL,
    last_action_type VARCHAR(50) DEFAULT NULL,
    schedule_count INT DEFAULT 0,
    failed_count INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_next_schedule_time (next_schedule_time, status)
);
```

**工作流程:**
```
定时扫描（每 60 秒）
    ↓
查询待调度分身（next_schedule_time <= now）
    ↓
并发执行（最多 10 个）
    ↓
调用 Action Service (ScheduleAction)
    ↓
更新调度配置：
  - 成功：计算下次调度时间（2-6 小时随机），重置失败计数
  - 失败：延迟 5 分钟重试，增加失败计数
    ↓
失败次数 >= 5：自动暂停调度
```

**与 Avatar Service 集成:**
- 当 Avatar Service 创建分身时，自动调用 Scheduler Service 启用调度
- 异步调用，失败不影响分身创建
- 分身创建成功后 2-6 小时内进行首次自动调度

**配置说明:**
```yaml
Schedule:
  ScanInterval: 60      # 扫描间隔（秒）
  MaxWorkers: 10        # 最大并发调度数

ActionSchedule:
  MinIntervalHours: 2   # 最小调度间隔（小时）
  MaxIntervalHours: 6   # 最大调度间隔（小时）
```

**监控指标:**
- 调度成功率：成功次数 / 总次数
- 平均调度延迟：实际执行时间 - 计划时间
- 活跃分身数：status = 'active' 的数量
- 暂停分身数：failed_count >= 5 的数量

**重要说明:**
- Scheduler Service 只负责"何时调度"，不关心"做什么"
- 具体行为由 Action Service 根据分身性格和时间决定
- 调度时间采用随机间隔，模拟真实生活的不确定性
- 服务启动时调度器自动开始工作，无需额外触发

---

### 8. **World Service (世界服务)**
**职责:**
管理第二空间的世界地图、区域、场景

**核心功能:**

#### a) 区域管理
- 管理 4 个基础区域:
  - 日常城市(咖啡厅、街区、公园)
  - 自然区域(森林、湖、山)
  - 社交广场(分身随机相遇)
  - 神秘区域(触发特殊事件)
- 每个区域包含:
  - 区域名称、描述
  - 场景列表(具体地点)
  - 可触发的事件类型
  - 区域氛围(白天/夜晚/天气)

#### b) 场景管理
- 每个区域下的具体场景
- 场景属性(图片、描述、适合的行为类型)
- 场景解锁条件(付费/成长等级)

#### c) 分身位置追踪
- 记录分身当前所在位置
- 分身移动历史
- 同区域的其他分身(社交功能)

**核心 API:**
- `GET /world/regions` - 获取所有区域
- `GET /world/region/{id}/scenes` - 获取区域下的场景
- `GET /world/avatar/{id}/location` - 获取分身当前位置
- `POST /world/avatar/{id}/move` - 移动分身到指定场景
- `GET /world/scene/{id}/avatars` - 获取场景中的其他分身

**与其他服务的关系:**
- Action Service 决定分身去哪个区域
- Event Service 根据区域生成对应事件
- 前端展示世界地图和分身位置

---

### 9. **Event Service (事件生成服务) ⭐核心**
**职责:**
管理事件模板,生成具体事件内容

**核心功能:**

#### a) 事件模板管理
- 存储 20+ 种事件模板(探索、社交、学习、创作、休息等)
- 每个模板包含:
  - 触发条件(性格要求、能量要求)
  - 事件类型(旅行/社交/创作...)
  - 适用区域/场景
  - 稀有度(common/rare/epic)
  - 冷却时间
  - 内容模板

#### b) 事件实例生成
- 接收 Action Service 的行为请求
- 根据行为类型和所在区域选择合适的事件模板
- **调用 AI Service 生成事件文本**
- 调用 ImageGen Service 生成图片
- 保存完整事件实例

#### c) 事件历史管理
- 存储分身的所有事件历史
- 提供时间线查询
- 事件对性格的影响记录

**核心 API:**
- `POST /event/generate` - 生成事件(由 Action Service 调用)
- `GET /event/{avatarId}/timeline` - 获取分身时间线
- `GET /event/templates` - 获取事件模板列表
- `POST /event/templates` - 创建事件模板(管理后台)

**工作流程:**
```
接收行动请求 → 查询分身位置(World Service) → 选择事件模板
→ 调用 AI Service 生成文本 → 调用 ImageGen 生成图片
→ 保存事件 → 返回事件数据 → Notify Service 推送给用户
```

---

### 10. **Dialogue Service (对话服务)**
**职责:**
- 用户与分身的聊天
- 管理对话上下文和历史
- 注入分身性格到对话中
- 情绪识别(从用户消息中识别情绪)

**关键点:**
- 对话时要注入:
  - 分身的性格设定
  - 最近发生的事件
  - 用户的长期记忆(通过 Memory Service)
- **所有 AI 调用通过 AI Service**
- 支持流式返回(WebSocket)

**核心 API:**
- `POST /dialogue/{avatarId}/message` - 发送消息
- `GET /dialogue/{avatarId}/history` - 获取历史
- `WS /dialogue/{avatarId}/stream` - 流式对话

**工作流程:**
```
用户消息 → 查询上下文(最近事件、记忆) → 构建 Prompt
→ 调用 AI Service (流式) → 返回给用户 → 保存对话历史
→ 更新关系分数(Avatar Service)
```

---

### 11. **Diary Service (日记服务)**
**职责:**
管理分身日记和用户日记的双向互动

**核心功能:**

#### a) 分身日记
- 每日自动生成分身日记(**调用 AI Service**)
- 记录分身今天的事件、心情、思考
- 基于当天的事件总结生成

#### b) 用户日记
- 用户写日记
- 分身自动回应(**调用 AI Service**)
- **情绪分析(调用 AI Service)**
- 情绪分析结果影响分身性格和关系分数

#### c) 日记管理
- 按日期查询
- 按心情/标签筛选
- 日记搜索
- 日记统计(连续记录天数、总字数等)

**核心 API:**
- `POST /diary/avatar/{id}/generate` - 生成分身日记(定时任务调用)
- `GET /diary/avatar/{id}/list` - 获取分身日记列表
- `GET /diary/avatar/{id}/detail` - 获取指定日期日记
- `POST /diary/user/create` - 用户写日记
- `GET /diary/user/list` - 获取用户日记列表
- `GET /diary/stats` - 获取日记统计数据

**工作流程:**

**分身日记生成:**
```
定时任务(每晚 22:00)
    ↓
Diary Service 触发
    ↓
查询今天的事件(Event Service)
    ↓
调用 AI Service 生成日记
    ↓
保存日记
    ↓
调用 Memory Service 向量化(如果重要)
    ↓
推送通知(Notify Service)
```

**用户写日记:**
```
用户提交日记
    ↓
Diary Service 保存
    ↓
调用 AI Service 情绪分析
    ↓
调用 AI Service 生成分身回应
    ↓
更新关系分数(Avatar Service)
    ↓
向量化存储(Memory Service)
```

---

### 12. **AI Service (AI 统一服务) ⭐核心**
**职责:**
统一管理所有 AI 调用，封装 Deepseek API

**核心功能:**

#### a) 统一 API 调用
- 封装 Deepseek API (deepseek-chat)
- 处理认证、限流、重试、降级
- 错误处理和日志记录
- 支持流式和非流式调用

#### b) Prompt 模板管理
- Prompt 模板存储和版本控制
- 变量注入和渲染
- 支持不同场景的模板:
  - avatar_chat (分身对话)
  - event_story (事件故事生成)
  - avatar_diary (分身日记生成)
  - user_diary_reply (用户日记回应)
  - emotion_analysis (情绪分析)

#### c) 智能缓存
- 相同请求返回缓存
- 减少重复调用，节省成本
- 可配置缓存策略

#### d) 监控统计
- Token 使用量统计
- 成本统计(按服务、按用户)
- 调用成功率监控
- 响应时间监控
- 错误日志

#### e) 多模型支持
- Chat 模型 (deepseek-chat)
- Embedding 模型 (文本向量化)
- 可扩展支持其他 AI 服务商

**核心 API:**
- `POST /ai/chat` - 对话生成(非流式)
- `POST /ai/chat/stream` - 流式对话
- `POST /ai/generate` - 文本生成(事件、日记)
- `POST /ai/analyze/emotion` - 情绪分析
- `POST /ai/embedding` - 文本向量化
- `GET /ai/prompts` - 获取 Prompt 模板列表
- `GET /ai/stats` - 获取使用统计
- `GET /ai/health` - 健康检查

**请求格式:**
```json
{
  "prompt_template": "avatar_chat",
  "variables": {
    "personality": {...},
    "recent_events": [...],
    "user_message": "..."
  },
  "model_config": {
    "temperature": 0.7,
    "max_tokens": 500
  },
  "stream": false
}
```

**工作流程:**
```
接收请求 → 检查缓存 → 加载 Prompt 模板
→ 注入变量 → 调用 Deepseek API
→ 记录日志和统计 → 返回结果
```

**技术实现:**
- Deepseek API SDK
- Redis 缓存
- Prompt 模板存储(数据库或配置文件)
- 异步队列处理(高并发场景)

---

### 13. **StoryGen Service (故事生成服务)**
**职责:**
- ~~调用 LLM 生成事件文本~~ (已废弃，由 AI Service 统一管理)
- **本服务已整合到 AI Service 中**

**说明:**
原 StoryGen Service 的功能现在由 AI Service 的不同 Prompt 模板实现:
- 事件文本生成 → AI Service (event_story 模板)
- 分身日记生成 → AI Service (avatar_diary 模板)

**本服务可以移除或保留作为业务逻辑层**

---

### 14. **Memory Service (记忆服务)**
**职责:**
- 长期记忆存储(向量数据库)
- 用户重要日记、关键事件的向量化(**调用 AI Service**)
- RAG 检索(检索相关记忆注入到对话中)

**技术:**
- 向量数据库(Milvus/Pinecone)
- **调用 AI Service 的 Embedding 接口**

**核心 API:**
- `POST /memory/store` - 存储记忆(向量化)
- `POST /memory/search` - 检索相关记忆

**工作流程:**
```
接收文本 → 调用 AI Service Embedding
→ 存储向量到向量数据库 → 返回
```

---

### 15. **ImageGen Service (图像生成服务)**
**职责:**
- 为事件生成插画
- 生成分身的表情图
- 生成分享海报
- 将生成的图片上传到阿里云 OSS

**技术:**
- Stable Diffusion 或调用图像生成 API
- 调用 OSS Service 上传图片

**核心 API:**
- `POST /image/generate` - 生成图片(异步)
- `GET /image/{taskId}` - 查询生成状态

**工作流程:**
```
1. 接收生成请求
2. 调用 AI 生成图片
3. 调用 OSS Service 上传到阿里云
4. 返回 OSS 图片 URL
```

---

### 16. **Notify Service (通知服务)**
**职责:**
- 推送通知(APNs/FCM)
- WebSocket 实时通知
- 未来硬件设备同步(MQTT)

**核心 API:**
- `POST /notify/push` - 发送推送
- `WS /notify/stream` - 实时通知流

---

## 🎮 MVP 核心功能详解

### **首页:分身正在做什么**
用户打开 App 看到的第一个画面:

**展示内容:**
- 分身当前动态(正在散步/看书/旅行...)
- 分身的状态动画
- 氛围背景(白天/夜晚/雨天...)
- 分身主动发来的消息
- 对话入口按钮

**技术实现:**
- Avatar Service 提供当前状态
- Event Service 提供最新事件
- 前端展示动画

---

### **分身模块:人格与成长**

#### 1. 性格面板
- 6 条动态曲线图
- 显示每个维度的数值(0-100)
- 随着事件和互动动态变化

#### 2. 分身日记
- AI 自动生成的日记
- 记录今天做了什么、心情如何
- 用户可以查看历史日记

#### 3. 成长节点
- 第一次旅行、第一次社交、第一次创作...
- 每个节点影响性格走向

#### 4. 关系面板
- 与用户的信任度、亲密度、共鸣度
- 关系越高,分身越愿意分享内心

---

### **世界模块:第二空间(轻版)**

MVP 不做大型地图,用**区域卡片系统**:

**4 个基础区域:**
- 日常城市(咖啡厅、街区、公园)
- 自然区域(森林、湖、山)
- 社交广场(分身随机相遇)
- 神秘区域(触发特殊事件)

**核心玩法:**
- 分身自动去某个地方
- 触发事件
- 遇到其他分身(系统模拟)
- 生成照片/心情/小日记
- 带着经历回来告诉用户

---

### **"我"模块:个人中心**
- 用户基本信息
- 分身初始设定
- 订阅入口
- 日记、聊天记录
- 情绪记录面板
- 隐私管理

---

## 🔄 典型用户体验流程

```
1. 用户注册 → 创建分身(选外形、起名字)
   ↓
2. 系统根据用户初始问答生成性格向量
   ↓
3. 分身开始"生活":
   - 每 2-6 小时自动触发一次行动
   - 生成事件(去了哪里、做了什么、遇见谁)
   ↓
4. 用户收到推送:"你的分身今天去了海边"
   ↓
5. 用户打开 App 查看:
   - 看到事件描述 + 图片
   - 看到分身写的小日记
   - 性格面板有微小变化
   ↓
6. 用户可以:
   - 与分身聊天
   - 写自己的日记(分身会回应)
   - 查看分身的成长轨迹
   ↓
7. 循环往复,分身持续成长
```

---

## 💡 关键技术点

### 事件生成 = 模板 + AI
- **模板**(20%)提供结构和世界观一致性
- **AI**(80%)生成个性化内容

### 人格驱动一切
- 对话风格由人格决定
- 事件选择由人格决定
- 行动倾向由人格决定

### 混合决策
- 不是纯 AI(成本高、不可控)
- 不是纯规则(无个性、枯燥)
- 而是**规则框架 + AI 填充内容**

---

## 🚀 开发优先级

建议开发顺序:

1. **SMS + OSS Service** (基础设施)
2. **User + Avatar Service** (基础数据层)
3. **AI Service** ⭐ (核心 - 所有 AI 调用的统一入口)
4. **World Service** (世界地图和区域)
5. **Action Service** (核心玩法 - 行动逻辑)
6. **Scheduler Service** ⭐ (核心 - 自动调度分身行为)
7. **Event Service** (事件生成 - 与 Action 配合)
8. **Diary Service** (日记系统 - 重要的情感功能)
9. **Dialogue Service** (用户交互)
10. **Memory Service** (长期记忆 - RAG)
11. **ImageGen + Notify** (体验完善)

---

## 📊 核心数据表

### users 表
```sql
id, phone,
subscription_tier, subscription_expire_at,
settings_json,  -- 用户设置(通知、隐私等)
created_at, updated_at
```
**说明:** 不存储昵称和头像,这些属于分身

### sms_codes 表
```sql
id, phone, code, expire_at,
verified, created_at
```

### avatars 表
```sql
id, user_id, name, avatar_url, appearance_config,
-- 6维人格
warmth, adventurous, social, creative, calm, energetic,
-- 当前状态
emotion_state, energy, mood,
-- 成长数据
growth_level, experience,
-- 关系数据
trust_score, intimacy_score, resonance_score,
created_at, updated_at
```

### avatar_milestones 表
```sql
id, avatar_id, milestone_type,
title, description,
achieved_at
```

### avatar_stats 表
```sql
avatar_id,
total_events, total_dialogues,
total_travels, total_socials, total_creations,
regions_explored, days_active,
last_active_at, updated_at
```

### avatar_schedules 表
```sql
id, avatar_id, status,
next_schedule_time, last_schedule_time,
last_action_type, schedule_count, failed_count,
created_at, updated_at
```

### event_templates 表
```sql
id, category, name, description,
trigger_conditions, rarity, cooldown_hours,
content_template, created_at
```

### world_regions 表
```sql
id, name, description, type,
unlock_condition, created_at
```

### world_scenes 表
```sql
id, region_id, name, description,
image_url, atmosphere, created_at
```

### avatar_locations 表
```sql
id, avatar_id, scene_id,
arrived_at, left_at
```

### events_history 表
```sql
id, avatar_id, template_id,
event_text, image_url, scene_id,
occurred_at, personality_changes
```

### dialogues 表
```sql
id, avatar_id, role (user/avatar),
message, emotion_detected,
created_at
```

### diaries 表
```sql
id, avatar_id, type (avatar/user),
date, title, content,
mood, tags,
reply_content,  -- 如果是用户日记,分身的回应
emotion_score,  -- 情绪分数
is_important,   -- 是否重要(是否向量化)
created_at
```

### ai_prompts 表
```sql
id, name, version,
scene_type,     -- avatar_chat/event_story/avatar_diary/emotion_analysis
system_prompt,
user_prompt_template,
model_config,   -- JSON: {temperature, max_tokens, etc}
is_active,
created_at, updated_at
```

### ai_call_logs 表
```sql
id, service_name, scene_type,
prompt_template_id,
user_id, avatar_id,
input_tokens, output_tokens,
cost,          -- 成本(分)
duration_ms,   -- 响应时间
status,        -- success/error
error_message,
created_at
```

---

---

## 🔧 阿里云服务配置

### 短信服务
- 需要配置阿里云短信模板
- 验证码有效期: 5 分钟
- 同一手机号限制: 1 分钟 1 次, 1 小时 5 次, 1 天 10 次

### OSS 对象存储
- Bucket 配置: 私有读写
- 客户端直传使用 STS 临时凭证
- 图片访问使用签名 URL(有效期可配置)
- 目录结构:
  - `/avatars/` - 用户头像
  - `/events/` - 事件图片
  - `/posters/` - 分享海报

---

---

## 📋 服务调用关系

**核心调度链（自动调度）:**
```
Scheduler Service (定时扫描，每 60 秒)
    ↓
查询待调度分身
    ↓
Action Service (行动调度 - ScheduleAction)
    ↓ 决定做什么行为 + 去哪里
World Service (查询/更新位置)
    ↓ 分身移动到新场景
Event Service (事件生成)
    ↓ 选择事件模板
AI Service (文本生成) ⭐
    ↓ 调用 Deepseek
ImageGen Service (图片生成)
    ↓ 上传到
OSS Service
    ↓ 事件完成
Scheduler Service (更新下次调度时间)
    ↓
Notify Service (推送通知)
    ↓
用户收到通知
```

**另一条重要调用链 - 对话:**
```
用户发送消息
    ↓
Dialogue Service (对话管理)
    ↓ 查询上下文
Memory Service (检索记忆)
    ↓ 构建 Prompt
AI Service (对话生成) ⭐
    ↓ 流式返回
WebSocket → 用户
```

**日记生成调用链:**
```
定时任务(22:00)
    ↓
Diary Service (日记管理)
    ↓ 查询今日事件
Event Service
    ↓ 生成日记
AI Service (文本生成) ⭐
    ↓ 向量化
Memory Service (存储)
    ↓ 推送
Notify Service
```

**关键点:**
- **Scheduler Service** 负责"何时调度" - 自动扫描和触发调度 ⭐
- **AI Service** 是所有 AI 调用的统一入口 ⭐
- **Action Service** 负责"决策" - 什么时候做什么、去哪里
- **World Service** 负责"世界" - 管理区域、场景、分身位置
- **Event Service** 负责"执行" - 根据位置和行为生成具体事件内容
- 所有服务通过 AI Service 调用 Deepseek，不直接调用 AI API
- Scheduler Service 实现分身的自主生活，无需外部 cron 触发

---

**文档版本:** v1.6
**更新时间:** 2025-12-04
**变更:**
- 新增 Scheduler Service (调度服务) - 自动调度分身行为执行 ⭐
- 实现分身自主生活，无需外部 cron 触发
- Avatar Service 创建分身时自动启用调度
- 调度采用 2-6 小时随机间隔，模拟真实生活
- 增加失败重试机制和自动暂停功能
- 更新服务调用关系和开发优先级
- (v1.5) 新增 AI Service (AI 统一服务) - 所有 AI 调用的统一入口
- (v1.5) 集成 Deepseek API 作为统一大模型服务
- (v1.5) 新增 Diary Service (日记服务)
- (v1.5) 明确 User 和 Avatar 的职责划分
