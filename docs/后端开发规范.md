# åç«¯å¼€å‘è§„èŒƒ

## ğŸ“‹ ç›®å½•

- [1. é¡¹ç›®ç»“æ„è§„èŒƒ](#1-é¡¹ç›®ç»“æ„è§„èŒƒ)
- [2. ä»£ç è§„èŒƒ](#2-ä»£ç è§„èŒƒ)
- [3. go-zero æœåŠ¡å¼€å‘è§„èŒƒ](#3-go-zero-æœåŠ¡å¼€å‘è§„èŒƒ)
- [4. æ•°æ®åº“è§„èŒƒ](#4-æ•°æ®åº“è§„èŒƒ)
- [5. API è®¾è®¡è§„èŒƒ](#5-api-è®¾è®¡è§„èŒƒ)
- [6. é”™è¯¯å¤„ç†è§„èŒƒ](#6-é”™è¯¯å¤„ç†è§„èŒƒ)
- [7. æ—¥å¿—è§„èŒƒ](#7-æ—¥å¿—è§„èŒƒ)
- [8. æµ‹è¯•è§„èŒƒ](#8-æµ‹è¯•è§„èŒƒ)
- [9. å®‰å…¨è§„èŒƒ](#9-å®‰å…¨è§„èŒƒ)
- [10. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ](#10-æ€§èƒ½ä¼˜åŒ–è§„èŒƒ)
- [11. ä»£ç å®¡æŸ¥æ¸…å•](#11-ä»£ç å®¡æŸ¥æ¸…å•)
- [12. å¸¸ç”¨å‘½ä»¤](#12-å¸¸ç”¨å‘½ä»¤)
- [13. Makefile ç®¡ç†è§„èŒƒ](#13-makefile-ç®¡ç†è§„èŒƒ)
- [14. å‚è€ƒèµ„æº](#14-å‚è€ƒèµ„æº)

---

## 1. é¡¹ç›®ç»“æ„è§„èŒƒ

### 1.1 æœåŠ¡ç›®å½•ç»“æ„

æ¯ä¸ª go-zero æœåŠ¡éµå¾ªç»Ÿä¸€çš„ç›®å½•ç»“æ„ï¼š

```
services/
â””â”€â”€ {service-name}/
    â”œâ”€â”€ api/                    # API æœåŠ¡ (å¯é€‰)
    â”‚   â”œâ”€â”€ {service}.api      # API å®šä¹‰æ–‡ä»¶
    â”‚   â”œâ”€â”€ {service}.go       # å…¥å£æ–‡ä»¶
    â”‚   â””â”€â”€ internal/
    â”‚       â”œâ”€â”€ config/        # é…ç½®
    â”‚       â”œâ”€â”€ handler/       # HTTP å¤„ç†å™¨
    â”‚       â”œâ”€â”€ logic/         # ä¸šåŠ¡é€»è¾‘
    â”‚       â”œâ”€â”€ svc/           # æœåŠ¡ä¸Šä¸‹æ–‡
    â”‚       â””â”€â”€ types/         # ç±»å‹å®šä¹‰
    â”‚
    â”œâ”€â”€ rpc/                    # RPC æœåŠ¡ (ä¸»è¦)
    â”‚   â”œâ”€â”€ {service}.proto    # Proto å®šä¹‰
    â”‚   â”œâ”€â”€ {service}.go       # å…¥å£æ–‡ä»¶
    â”‚   â””â”€â”€ internal/
    â”‚       â”œâ”€â”€ config/        # é…ç½®
    â”‚       â”œâ”€â”€ logic/         # ä¸šåŠ¡é€»è¾‘
    â”‚       â”œâ”€â”€ server/        # gRPC æœåŠ¡å™¨
    â”‚       â”œâ”€â”€ svc/           # æœåŠ¡ä¸Šä¸‹æ–‡
    â”‚       â””â”€â”€ model/         # æ•°æ®æ¨¡å‹
    â”‚
    â”œâ”€â”€ model/                  # æ•°æ®æ¨¡å‹ (å…±äº«)
    â”‚   â”œâ”€â”€ {table}model.go    # è¡¨æ¨¡å‹
    â”‚   â””â”€â”€ vars.go            # å¸¸é‡å®šä¹‰
    â”‚
    â””â”€â”€ README.md              # æœåŠ¡è¯´æ˜æ–‡æ¡£
```

### 1.2 å…¬å…±åº“ç›®å½•

```
pkg/
â”œâ”€â”€ llmclient/              # LLM å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ vectorclient/           # å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯
â”œâ”€â”€ ossclient/              # OSS å®¢æˆ·ç«¯
â”œâ”€â”€ smsclient/              # çŸ­ä¿¡å®¢æˆ·ç«¯
â”œâ”€â”€ middleware/             # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.go            # è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ logger.go          # æ—¥å¿—ä¸­é—´ä»¶
â”‚   â””â”€â”€ recovery.go        # æ¢å¤ä¸­é—´ä»¶
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ crypto.go          # åŠ å¯†å·¥å…·
â”‚   â”œâ”€â”€ time.go            # æ—¶é—´å·¥å…·
â”‚   â””â”€â”€ validator.go       # éªŒè¯å·¥å…·
â”œâ”€â”€ errcode/                # é”™è¯¯ç å®šä¹‰
â”‚   â””â”€â”€ code.go
â””â”€â”€ response/               # ç»Ÿä¸€å“åº”
    â””â”€â”€ response.go
```

---

## 2. ä»£ç è§„èŒƒ

### 2.1 å‘½åè§„èŒƒ

#### æ–‡ä»¶å‘½å
- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿: `user_service.go`
- æµ‹è¯•æ–‡ä»¶: `user_service_test.go`
- æ¨¡å‹æ–‡ä»¶: `{table}model.go`

#### å˜é‡å‘½å
```go
// âœ… æ¨è
var userID int64
var userName string
var isActive bool

// âŒ ä¸æ¨è
var user_id int64
var UserName string
var is_active bool
```

#### å¸¸é‡å‘½å
```go
// âœ… æ¨è - ä½¿ç”¨é©¼å³°æˆ–å…¨å¤§å†™
const (
    MaxRetryCount = 3
    DefaultTimeout = 30 * time.Second
)

const (
    STATUS_ACTIVE   = 1
    STATUS_INACTIVE = 0
)
```

#### å‡½æ•°å‘½å
```go
// âœ… æ¨è - åŠ¨è¯å¼€å¤´ï¼Œé©¼å³°å‘½å
func GetUserByID(id int64) (*User, error)
func CreateAvatar(req *CreateAvatarRequest) error
func UpdatePersonality(avatarID int64, personality *Personality) error

// âŒ ä¸æ¨è
func user_by_id(id int64) (*User, error)
func avatar_create(req *CreateAvatarRequest) error
```

#### æ¥å£å‘½å
```go
// âœ… æ¨è - ä»¥ er ç»“å°¾æˆ–æè¿°æ€§åè¯
type UserRepository interface {
    FindByID(id int64) (*User, error)
    Create(user *User) error
}

type AvatarService interface {
    GetPersonality(avatarID int64) (*Personality, error)
}
```

### 2.2 æ³¨é‡Šè§„èŒƒ

#### åŒ…æ³¨é‡Š
```go
// Package userservice æä¾›ç”¨æˆ·è´¦å·ç®¡ç†åŠŸèƒ½
// åŒ…æ‹¬ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¢é˜…ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½
package userservice
```

#### å‡½æ•°æ³¨é‡Š
```go
// GetUserByPhone æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
// å‚æ•°:
//   - phone: æ‰‹æœºå·ç 
// è¿”å›:
//   - *User: ç”¨æˆ·å¯¹è±¡
//   - error: é”™è¯¯ä¿¡æ¯ï¼Œç”¨æˆ·ä¸å­˜åœ¨æ—¶è¿”å› ErrUserNotFound
func GetUserByPhone(phone string) (*User, error) {
    // ...
}
```

#### å¤æ‚é€»è¾‘æ³¨é‡Š
```go
// è®¡ç®—åˆ†èº«è¡ŒåŠ¨æ„å›¾
// 1. æ”¶é›†æ—¶é—´æ®µæƒé‡
// 2. è®¡ç®—äººæ ¼åŒ¹é…åº¦
// 3. åº”ç”¨ç”¨æˆ·äº’åŠ¨å› å­
// 4. æ·»åŠ éšæœºå™ªå£°
score := timeWeight*0.3 + personalityWeight*0.4 +
         userInteractionWeight*0.2 + randomNoise*0.1
```

### 2.3 ä»£ç æ ¼å¼

#### å¯¼å…¥é¡ºåº
```go
import (
    // æ ‡å‡†åº“
    "context"
    "fmt"
    "time"

    // ç¬¬ä¸‰æ–¹åº“
    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/core/stores/sqlx"

    // é¡¹ç›®å†…éƒ¨
    "me2/pkg/errcode"
    "me2/services/user/model"
)
```

#### å‡½æ•°é•¿åº¦
- å•ä¸ªå‡½æ•°ä¸è¶…è¿‡ 80 è¡Œ
- è¶…è¿‡åˆ™æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•°

#### æ–‡ä»¶é•¿åº¦
- å•ä¸ªä»£ç æ–‡ä»¶ä¸è¶…è¿‡ 500 è¡Œ
- è¶…è¿‡åˆ™æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶æˆ–æ¨¡å—

#### è¡Œå®½
- æ¯è¡Œä»£ç ä¸è¶…è¿‡ 120 å­—ç¬¦
- è¶…è¿‡åˆ™æ¢è¡Œ

---

## 3. go-zero æœåŠ¡å¼€å‘è§„èŒƒ

### 3.1 API å®šä¹‰è§„èŒƒ

```api
syntax = "v1"

info(
    title: "ç”¨æˆ·æœåŠ¡ API"
    desc: "ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†"
    author: "AI Avatar Team"
    version: "v1.0"
)

type (
    // ç™»å½•è¯·æ±‚
    LoginRequest {
        Phone string `json:"phone" validate:"required,phone"`
        Code  string `json:"code" validate:"required,len=6"`
    }

    // ç™»å½•å“åº”
    LoginResponse {
        Token    string `json:"token"`
        UserID   int64  `json:"user_id"`
        AvatarID int64  `json:"avatar_id,omitempty"`
    }
)

@server(
    group: auth
    prefix: /api/v1/auth
)
service user {
    @doc "ç”¨æˆ·ç™»å½•"
    @handler login
    post /login (LoginRequest) returns (LoginResponse)
}
```

### 3.2 Proto å®šä¹‰è§„èŒƒ

```protobuf
syntax = "proto3";

package user;
option go_package = "./user";

// ç”¨æˆ·æœåŠ¡
service User {
  // æ ¹æ® ID è·å–ç”¨æˆ·
  rpc GetUserByID(GetUserByIDRequest) returns (GetUserByIDResponse);

  // åˆ›å»ºç”¨æˆ·
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
}

// è¯·æ±‚æ¶ˆæ¯
message GetUserByIDRequest {
  int64 user_id = 1;
}

// å“åº”æ¶ˆæ¯
message GetUserByIDResponse {
  int64 user_id = 1;
  string phone = 2;
  int32 subscription_tier = 3;
  int64 created_at = 4;
}
```

### 3.3 é…ç½®æ–‡ä»¶è§„èŒƒ

```yaml
Name: user-rpc
ListenOn: 0.0.0.0:8080

# æ•°æ®åº“é…ç½®
DB:
  DataSource: postgres://user:pass@localhost:5432/me2?sslmode=disable
  MaxOpenConns: 100
  MaxIdleConns: 10
  MaxLifetime: 3600

# Redis é…ç½®
Redis:
  Host: localhost:6379
  Type: node
  Pass: ""

# æ—¥å¿—é…ç½®
Log:
  ServiceName: user-rpc
  Mode: console
  Level: info
  Encoding: json

# é“¾è·¯è¿½è¸ª
Telemetry:
  Name: user-rpc
  Endpoint: http://localhost:14268/api/traces
  Sampler: 1.0
  Batcher: jaeger
```

### 3.4 Logic å±‚è§„èŒƒ

```go
type GetUserLogic struct {
    ctx    context.Context
    svcCtx *svc.ServiceContext
    logx.Logger
}

func NewGetUserLogic(ctx context.Context, svcCtx *svc.ServiceContext) *GetUserLogic {
    return &GetUserLogic{
        ctx:    ctx,
        svcCtx: svcCtx,
        Logger: logx.WithContext(ctx),
    }
}

// GetUser è·å–ç”¨æˆ·ä¿¡æ¯
// ä¸šåŠ¡é€»è¾‘:
// 1. å‚æ•°éªŒè¯
// 2. æŸ¥è¯¢æ•°æ®åº“
// 3. è¿”å›ç»“æœ
func (l *GetUserLogic) GetUser(in *user.GetUserRequest) (*user.GetUserResponse, error) {
    // 1. å‚æ•°éªŒè¯
    if in.UserId <= 0 {
        return nil, errcode.ErrInvalidParam
    }

    // 2. æŸ¥è¯¢æ•°æ®åº“
    userModel, err := l.svcCtx.UserModel.FindOne(l.ctx, in.UserId)
    if err != nil {
        if err == model.ErrNotFound {
            return nil, errcode.ErrUserNotFound
        }
        l.Errorf("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: %v", err)
        return nil, errcode.ErrInternalServer
    }

    // 3. è¿”å›ç»“æœ
    return &user.GetUserResponse{
        UserId: userModel.Id,
        Phone:  userModel.Phone,
    }, nil
}
```

---

## 4. æ•°æ®åº“è§„èŒƒ

### 4.1 è¡¨å‘½åè§„èŒƒ

- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- ä½¿ç”¨å¤æ•°å½¢å¼: `users`, `avatars`, `events_history`
- å…³è”è¡¨ä½¿ç”¨ä¸¤ä¸ªè¡¨å: `avatar_locations`

### 4.2 å­—æ®µå‘½åè§„èŒƒ

```sql
-- âœ… æ¨è
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    phone VARCHAR(20) NOT NULL UNIQUE,
    subscription_tier INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- âŒ ä¸æ¨è
CREATE TABLE Users (
    ID BIGSERIAL PRIMARY KEY,
    Phone VARCHAR(20),
    SubscriptionTier INT
);
```

### 4.3 ç´¢å¼•è§„èŒƒ

```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_users_phone ON users(phone);

-- æ™®é€šç´¢å¼•
CREATE INDEX idx_avatars_user_id ON avatars(user_id);

-- å¤åˆç´¢å¼• (æœ€å¸¸æŸ¥è¯¢çš„å­—æ®µåœ¨å‰)
CREATE INDEX idx_events_avatar_time ON events_history(avatar_id, occurred_at DESC);
```

### 4.4 Model å±‚è§„èŒƒ

```go
package model

import (
    "context"
    "database/sql"
    "github.com/zeromicro/go-zero/core/stores/sqlx"
)

var _ UserModel = (*customUserModel)(nil)

type (
    // UserModel ç”¨æˆ·æ¨¡å‹æ¥å£
    UserModel interface {
        userModel
        // è‡ªå®šä¹‰æ–¹æ³•
        FindByPhone(ctx context.Context, phone string) (*User, error)
        UpdateSubscription(ctx context.Context, userID int64, tier int) error
    }

    customUserModel struct {
        *defaultUserModel
    }
)

// NewUserModel åˆ›å»ºç”¨æˆ·æ¨¡å‹
func NewUserModel(conn sqlx.SqlConn) UserModel {
    return &customUserModel{
        defaultUserModel: newUserModel(conn),
    }
}

// FindByPhone æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
func (m *customUserModel) FindByPhone(ctx context.Context, phone string) (*User, error) {
    query := `SELECT * FROM users WHERE phone = $1 LIMIT 1`
    var user User
    err := m.conn.QueryRowCtx(ctx, &user, query, phone)
    if err != nil {
        if err == sql.ErrNoRows {
            return nil, ErrNotFound
        }
        return nil, err
    }
    return &user, nil
}
```

---

## 5. API è®¾è®¡è§„èŒƒ

### 5.1 RESTful è§„èŒƒ

```
GET    /api/v1/users/:id          # è·å–ç”¨æˆ·
POST   /api/v1/users               # åˆ›å»ºç”¨æˆ·
PUT    /api/v1/users/:id          # æ›´æ–°ç”¨æˆ·
DELETE /api/v1/users/:id          # åˆ é™¤ç”¨æˆ·

GET    /api/v1/avatars/:id/personality    # è·å–æ€§æ ¼
PATCH  /api/v1/avatars/:id/personality    # æ›´æ–°æ€§æ ¼
```

### 5.2 ç»Ÿä¸€å“åº”æ ¼å¼

```go
// æˆåŠŸå“åº”
{
    "code": 0,
    "msg": "success",
    "data": {
        "user_id": 123,
        "phone": "13800138000"
    }
}

// é”™è¯¯å“åº”
{
    "code": 10001,
    "msg": "ç”¨æˆ·ä¸å­˜åœ¨",
    "data": null
}
```

### 5.3 å“åº”å°è£…

```go
package response

type Response struct {
    Code int         `json:"code"`
    Msg  string      `json:"msg"`
    Data interface{} `json:"data,omitempty"`
}

func Success(data interface{}) *Response {
    return &Response{
        Code: 0,
        Msg:  "success",
        Data: data,
    }
}

func Error(code int, msg string) *Response {
    return &Response{
        Code: code,
        Msg:  msg,
        Data: nil,
    }
}
```

### 5.4 åˆ†é¡µè§„èŒƒ

```go
type PageRequest struct {
    Page     int `json:"page" form:"page" validate:"min=1"`
    PageSize int `json:"page_size" form:"page_size" validate:"min=1,max=100"`
}

type PageResponse struct {
    Total    int64       `json:"total"`
    Page     int         `json:"page"`
    PageSize int         `json:"page_size"`
    List     interface{} `json:"list"`
}
```

---

## 6. é”™è¯¯å¤„ç†è§„èŒƒ

### 6.1 é”™è¯¯ç å®šä¹‰

```go
package errcode

var (
    // é€šç”¨é”™è¯¯ (1xxxx)
    ErrInvalidParam    = NewError(10001, "å‚æ•°é”™è¯¯")
    ErrInternalServer  = NewError(10002, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯")
    ErrUnauthorized    = NewError(10003, "æœªæˆæƒ")

    // ç”¨æˆ·ç›¸å…³ (2xxxx)
    ErrUserNotFound    = NewError(20001, "ç”¨æˆ·ä¸å­˜åœ¨")
    ErrUserExists      = NewError(20002, "ç”¨æˆ·å·²å­˜åœ¨")
    ErrInvalidCode     = NewError(20003, "éªŒè¯ç é”™è¯¯")

    // åˆ†èº«ç›¸å…³ (3xxxx)
    ErrAvatarNotFound  = NewError(30001, "åˆ†èº«ä¸å­˜åœ¨")
    ErrAvatarExists    = NewError(30002, "åˆ†èº«å·²å­˜åœ¨")

    // AI ç›¸å…³ (4xxxx)
    ErrAIServiceFailed = NewError(40001, "AI æœåŠ¡è°ƒç”¨å¤±è´¥")
    ErrPromptNotFound  = NewError(40002, "Prompt æ¨¡æ¿ä¸å­˜åœ¨")
)

type Error struct {
    Code int
    Msg  string
}

func NewError(code int, msg string) *Error {
    return &Error{Code: code, Msg: msg}
}

func (e *Error) Error() string {
    return e.Msg
}
```

### 6.2 é”™è¯¯å¤„ç†æ¨¡å¼

```go
// âœ… æ¨è - æ˜ç¡®çš„é”™è¯¯å¤„ç†
user, err := l.svcCtx.UserModel.FindOne(l.ctx, userID)
if err != nil {
    if err == model.ErrNotFound {
        return nil, errcode.ErrUserNotFound
    }
    l.Errorf("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: userID=%d, err=%v", userID, err)
    return nil, errcode.ErrInternalServer
}

// âŒ ä¸æ¨è - å¿½ç•¥é”™è¯¯
user, _ := l.svcCtx.UserModel.FindOne(l.ctx, userID)
```

### 6.3 é”™è¯¯æ—¥å¿—

```go
// è®°å½•é”™è¯¯ä¸Šä¸‹æ–‡
l.Errorf("åˆ›å»ºåˆ†èº«å¤±è´¥: userID=%d, name=%s, err=%v",
    req.UserId, req.Name, err)

// è®°å½•å †æ ˆä¿¡æ¯ (ä¸¥é‡é”™è¯¯)
l.Errorw("AI æœåŠ¡è°ƒç”¨å¤±è´¥",
    logx.Field("user_id", userID),
    logx.Field("prompt_id", promptID),
    logx.Field("error", err),
    logx.Field("stack", string(debug.Stack())),
)
```

---

## 7. æ—¥å¿—è§„èŒƒ

### 7.1 æ—¥å¿—çº§åˆ«

```go
// Debug - è°ƒè¯•ä¿¡æ¯
l.Debugf("æŸ¥è¯¢å‚æ•°: userID=%d, page=%d", userID, page)

// Info - ä¸€èˆ¬ä¿¡æ¯
l.Infof("ç”¨æˆ·ç™»å½•æˆåŠŸ: userID=%d, phone=%s", userID, phone)

// Warn - è­¦å‘Šä¿¡æ¯
l.Warnf("éªŒè¯ç å³å°†è¿‡æœŸ: phone=%s, expireAt=%v", phone, expireAt)

// Error - é”™è¯¯ä¿¡æ¯
l.Errorf("æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: err=%v", err)
```

### 7.2 ç»“æ„åŒ–æ—¥å¿—

```go
// âœ… æ¨è - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
l.Infow("AI è°ƒç”¨æˆåŠŸ",
    logx.Field("service", "event"),
    logx.Field("avatar_id", avatarID),
    logx.Field("template_id", templateID),
    logx.Field("tokens", tokens),
    logx.Field("duration_ms", duration),
)

// âŒ ä¸æ¨è - å­—ç¬¦ä¸²æ‹¼æ¥
l.Infof("AI è°ƒç”¨æˆåŠŸ: service=event, avatar_id=%d, tokens=%d", avatarID, tokens)
```

### 7.3 æ•æ„Ÿä¿¡æ¯è„±æ•

```go
// âœ… æ¨è - è„±æ•å¤„ç†
phone := "13800138000"
maskedPhone := phone[:3] + "****" + phone[7:]
l.Infof("å‘é€éªŒè¯ç : phone=%s", maskedPhone) // 138****8000

// âŒ ä¸æ¨è - ç›´æ¥è®°å½•æ•æ„Ÿä¿¡æ¯
l.Infof("å‘é€éªŒè¯ç : phone=%s", phone)
```

---

## 8. æµ‹è¯•è§„èŒƒ

### 8.1 å•å…ƒæµ‹è¯•

```go
package logic

import (
    "context"
    "testing"
    "github.com/stretchr/testify/assert"
)

func TestGetUserLogic_GetUser(t *testing.T) {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    ctx := context.Background()
    svcCtx := &svc.ServiceContext{
        // Mock ä¾èµ–
    }

    logic := NewGetUserLogic(ctx, svcCtx)

    // æµ‹è¯•ç”¨ä¾‹
    tests := []struct {
        name    string
        userID  int64
        want    *user.GetUserResponse
        wantErr bool
    }{
        {
            name:   "æ­£å¸¸è·å–ç”¨æˆ·",
            userID: 1,
            want: &user.GetUserResponse{
                UserId: 1,
                Phone:  "13800138000",
            },
            wantErr: false,
        },
        {
            name:    "ç”¨æˆ·ä¸å­˜åœ¨",
            userID:  999,
            want:    nil,
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := logic.GetUser(&user.GetUserRequest{
                UserId: tt.userID,
            })

            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
                assert.Equal(t, tt.want, got)
            }
        })
    }
}
```

### 8.2 æµ‹è¯•è¦†ç›–ç‡

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -v -cover ./...

# ç”Ÿæˆ HTML è¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# è¦æ±‚: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡ > 80%
```

### 8.3 åŸºå‡†æµ‹è¯•

```go
func BenchmarkGetUser(b *testing.B) {
    ctx := context.Background()
    svcCtx := &svc.ServiceContext{}
    logic := NewGetUserLogic(ctx, svcCtx)

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        logic.GetUser(&user.GetUserRequest{UserId: 1})
    }
}
```

---

## 9. å®‰å…¨è§„èŒƒ

### 9.1 SQL æ³¨å…¥é˜²æŠ¤

```go
// âœ… æ¨è - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
query := `SELECT * FROM users WHERE phone = $1`
err := m.conn.QueryRowCtx(ctx, &user, query, phone)

// âŒ ä¸æ¨è - å­—ç¬¦ä¸²æ‹¼æ¥
query := fmt.Sprintf("SELECT * FROM users WHERE phone = '%s'", phone)
```

### 9.2 å¯†ç å¤„ç†

```go
import "golang.org/x/crypto/bcrypt"

// å¯†ç åŠ å¯†
func HashPassword(password string) (string, error) {
    bytes, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
    return string(bytes), err
}

// å¯†ç éªŒè¯
func CheckPassword(password, hash string) bool {
    err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
    return err == nil
}
```

### 9.3 JWT è®¤è¯

```go
// ç”Ÿæˆ Token
func GenerateToken(userID int64, secret string) (string, error) {
    claims := jwt.MapClaims{
        "user_id": userID,
        "exp":     time.Now().Add(7 * 24 * time.Hour).Unix(),
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    return token.SignedString([]byte(secret))
}

// éªŒè¯ Token
func ParseToken(tokenString, secret string) (int64, error) {
    token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {
        return []byte(secret), nil
    })
    if err != nil || !token.Valid {
        return 0, errcode.ErrUnauthorized
    }

    claims := token.Claims.(jwt.MapClaims)
    userID := int64(claims["user_id"].(float64))
    return userID, nil
}
```

### 9.4 æ•æ„Ÿæ•°æ®åŠ å¯†

```go
// ä½¿ç”¨ AES åŠ å¯†æ•æ„Ÿæ•°æ®
import "crypto/aes"

// ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
// ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒè¯»å–
encryptionKey := os.Getenv("ENCRYPTION_KEY")
```

---

## 10. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 10.1 æ•°æ®åº“ä¼˜åŒ–

```go
// âœ… æ¨è - æ‰¹é‡æŸ¥è¯¢
userIDs := []int64{1, 2, 3, 4, 5}
users, err := l.svcCtx.UserModel.FindByIDs(ctx, userIDs)

// âŒ ä¸æ¨è - å¾ªç¯æŸ¥è¯¢ (N+1 é—®é¢˜)
for _, id := range userIDs {
    user, _ := l.svcCtx.UserModel.FindOne(ctx, id)
}
```

### 10.2 ç¼“å­˜ä½¿ç”¨

```go
// æŸ¥è¯¢æ—¶å…ˆæŸ¥ç¼“å­˜
cacheKey := fmt.Sprintf("user:%d", userID)
cached, err := l.svcCtx.Redis.Get(cacheKey)
if err == nil {
    var user User
    json.Unmarshal([]byte(cached), &user)
    return &user, nil
}

// ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
user, err := l.svcCtx.UserModel.FindOne(ctx, userID)
if err != nil {
    return nil, err
}

// å†™å…¥ç¼“å­˜ (è®¾ç½®è¿‡æœŸæ—¶é—´)
data, _ := json.Marshal(user)
l.svcCtx.Redis.Setex(cacheKey, string(data), 3600)
```

### 10.3 å¹¶å‘æ§åˆ¶

```go
// ä½¿ç”¨ sync.WaitGroup å¹¶å‘å¤„ç†
var wg sync.WaitGroup
results := make(chan *Result, len(avatarIDs))

for _, avatarID := range avatarIDs {
    wg.Add(1)
    go func(id int64) {
        defer wg.Done()
        result := processAvatar(id)
        results <- result
    }(avatarID)
}

wg.Wait()
close(results)
```

### 10.4 è¿æ¥æ± é…ç½®

```yaml
DB:
  MaxOpenConns: 100      # æœ€å¤§æ‰“å¼€è¿æ¥æ•°
  MaxIdleConns: 10       # æœ€å¤§ç©ºé—²è¿æ¥æ•°
  MaxLifetime: 3600      # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ(ç§’)

Redis:
  PoolSize: 100          # è¿æ¥æ± å¤§å°
  MinIdleConns: 10       # æœ€å°ç©ºé—²è¿æ¥æ•°
```

---

## 11. ä»£ç å®¡æŸ¥æ¸…å•

æäº¤ä»£ç å‰è¯·ç¡®è®¤ï¼š

- [ ] ä»£ç ç¬¦åˆå‘½åè§„èŒƒ
- [ ] æ·»åŠ äº†å¿…è¦çš„æ³¨é‡Š
- [ ] é”™è¯¯å¤„ç†å®Œæ•´
- [ ] æ·»åŠ äº†æ—¥å¿—è®°å½•
- [ ] ç¼–å†™äº†å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] è¿è¡Œ `gofmt` æ ¼å¼åŒ–ä»£ç 
- [ ] è¿è¡Œ `golint` æ£€æŸ¥ä»£ç 
- [ ] è¿è¡Œ `go vet` æ£€æŸ¥é—®é¢˜
- [ ] æ²¡æœ‰ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- [ ] SQL ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- [ ] æ·»åŠ äº†å¿…è¦çš„ç´¢å¼•
- [ ] è€ƒè™‘äº†å¹¶å‘å®‰å…¨
- [ ] è€ƒè™‘äº†æ€§èƒ½ä¼˜åŒ–

---

## 12. å¸¸ç”¨å‘½ä»¤

```bash
# æ ¼å¼åŒ–ä»£ç 
gofmt -w .

# ä»£ç æ£€æŸ¥
golint ./...
go vet ./...

# è¿è¡Œæµ‹è¯•
go test -v ./...

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out

# ç”Ÿæˆ API ä»£ç 
goctl api go -api user.api -dir .

# ç”Ÿæˆ RPC ä»£ç 
goctl rpc protoc user.proto --go_out=. --go-grpc_out=. --zrpc_out=.

# ç”Ÿæˆ Model ä»£ç 
goctl model pg datasource -url="postgres://user:pass@localhost:5432/me2" -table="users" -dir="./model"
```

---

## 13. Makefile ç®¡ç†è§„èŒƒ

### 13.1 Makefile ç»“æ„

æ¯ä¸ªæœåŠ¡æ ¹ç›®å½•ä¸‹åº”åŒ…å« Makefile æ–‡ä»¶ï¼Œç»Ÿä¸€ç®¡ç†å¸¸ç”¨å‘½ä»¤ã€‚

```makefile
# æœåŠ¡åç§°
SERVICE_NAME := user-rpc
API_FILE := user.api
PROTO_FILE := user.proto

# é»˜è®¤ç›®æ ‡
.PHONY: help
help:
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make build       - ç¼–è¯‘æœåŠ¡"
	@echo "  make run         - è¿è¡ŒæœåŠ¡"
	@echo "  make test        - è¿è¡Œæµ‹è¯•"
	@echo "  make cover       - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  make lint        - ä»£ç æ£€æŸ¥"
	@echo "  make fmt         - æ ¼å¼åŒ–ä»£ç "
	@echo "  make gen-api     - ç”Ÿæˆ API ä»£ç "
	@echo "  make gen-rpc     - ç”Ÿæˆ RPC ä»£ç "
	@echo "  make gen-model   - ç”Ÿæˆ Model ä»£ç "
	@echo "  make clean       - æ¸…ç†æ„å»ºæ–‡ä»¶"

# ç¼–è¯‘
.PHONY: build
build:
	@echo "ç¼–è¯‘ $(SERVICE_NAME)..."
	@go build -o bin/$(SERVICE_NAME) .

# è¿è¡Œ
.PHONY: run
run:
	@echo "è¿è¡Œ $(SERVICE_NAME)..."
	@go run .

# æµ‹è¯•
.PHONY: test
test:
	@echo "è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# è¦†ç›–ç‡
.PHONY: cover
cover:
	@echo "ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	@go test -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: coverage.html"

# ä»£ç æ£€æŸ¥
.PHONY: lint
lint:
	@echo "ä»£ç æ£€æŸ¥..."
	@golint ./...
	@go vet ./...

# æ ¼å¼åŒ–
.PHONY: fmt
fmt:
	@echo "æ ¼å¼åŒ–ä»£ç ..."
	@gofmt -w .

# ç”Ÿæˆ API ä»£ç 
.PHONY: gen-api
gen-api:
	@echo "ç”Ÿæˆ API ä»£ç ..."
	@goctl api go -api $(API_FILE) -dir .

# ç”Ÿæˆ RPC ä»£ç 
.PHONY: gen-rpc
gen-rpc:
	@echo "ç”Ÿæˆ RPC ä»£ç ..."
	@goctl rpc protoc $(PROTO_FILE) --go_out=. --go-grpc_out=. --zrpc_out=.

# ç”Ÿæˆ Model ä»£ç 
.PHONY: gen-model
gen-model:
	@echo "ç”Ÿæˆ Model ä»£ç ..."
	@goctl model pg datasource -url="$(DB_URL)" -table="$(TABLE)" -dir="./model"

# æ¸…ç†
.PHONY: clean
clean:
	@echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf bin/
	@rm -f coverage.out coverage.html
```

### 13.2 é¡¹ç›®æ ¹ç›®å½• Makefile

é¡¹ç›®æ ¹ç›®å½•çš„ Makefile ç”¨äºç®¡ç†æ‰€æœ‰æœåŠ¡ï¼š

```makefile
# é¡¹ç›®åç§°
PROJECT_NAME := me2

# æœåŠ¡åˆ—è¡¨
SERVICES := user avatar ai event action world dialogue diary memory imagegen notify sms oss

.PHONY: help
help:
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make build-all   - ç¼–è¯‘æ‰€æœ‰æœåŠ¡"
	@echo "  make test-all    - æµ‹è¯•æ‰€æœ‰æœåŠ¡"
	@echo "  make fmt-all     - æ ¼å¼åŒ–æ‰€æœ‰ä»£ç "
	@echo "  make lint-all    - æ£€æŸ¥æ‰€æœ‰ä»£ç "
	@echo "  make clean-all   - æ¸…ç†æ‰€æœ‰æ„å»ºæ–‡ä»¶"
	@echo "  make docker-up   - å¯åŠ¨ Docker ç¯å¢ƒ"
	@echo "  make docker-down - åœæ­¢ Docker ç¯å¢ƒ"

# ç¼–è¯‘æ‰€æœ‰æœåŠ¡
.PHONY: build-all
build-all:
	@for service in $(SERVICES); do \
		echo "ç¼–è¯‘ $$service..."; \
		cd services/$$service && make build && cd ../..; \
	done

# æµ‹è¯•æ‰€æœ‰æœåŠ¡
.PHONY: test-all
test-all:
	@for service in $(SERVICES); do \
		echo "æµ‹è¯• $$service..."; \
		cd services/$$service && make test && cd ../..; \
	done

# æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
.PHONY: fmt-all
fmt-all:
	@echo "æ ¼å¼åŒ–æ‰€æœ‰ä»£ç ..."
	@gofmt -w .

# æ£€æŸ¥æ‰€æœ‰ä»£ç 
.PHONY: lint-all
lint-all:
	@echo "æ£€æŸ¥æ‰€æœ‰ä»£ç ..."
	@golint ./...
	@go vet ./...

# æ¸…ç†æ‰€æœ‰æ„å»ºæ–‡ä»¶
.PHONY: clean-all
clean-all:
	@for service in $(SERVICES); do \
		echo "æ¸…ç† $$service..."; \
		cd services/$$service && make clean && cd ../..; \
	done

# Docker ç¯å¢ƒ
.PHONY: docker-up
docker-up:
	@echo "å¯åŠ¨ Docker ç¯å¢ƒ..."
	@docker-compose up -d

.PHONY: docker-down
docker-down:
	@echo "åœæ­¢ Docker ç¯å¢ƒ..."
	@docker-compose down
```

### 13.3 ä½¿ç”¨è§„èŒƒ

#### å‘½åè§„èŒƒ
- ç›®æ ‡åä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦: `build`, `test`, `gen-api`
- æ‰€æœ‰ç›®æ ‡éƒ½åº”å£°æ˜ä¸º `.PHONY`

#### å¿…éœ€ç›®æ ‡
æ¯ä¸ªæœåŠ¡çš„ Makefile å¿…é¡»åŒ…å«ä»¥ä¸‹ç›®æ ‡ï¼š
- `help` - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- `build` - ç¼–è¯‘æœåŠ¡
- `run` - è¿è¡ŒæœåŠ¡
- `test` - è¿è¡Œæµ‹è¯•
- `fmt` - æ ¼å¼åŒ–ä»£ç 
- `lint` - ä»£ç æ£€æŸ¥
- `clean` - æ¸…ç†æ„å»ºæ–‡ä»¶

#### å¯é€‰ç›®æ ‡
æ ¹æ®æœåŠ¡ç±»å‹æ·»åŠ ï¼š
- `gen-api` - API æœåŠ¡éœ€è¦
- `gen-rpc` - RPC æœåŠ¡éœ€è¦
- `gen-model` - æœ‰æ•°æ®åº“çš„æœåŠ¡éœ€è¦
- `cover` - éœ€è¦è¦†ç›–ç‡æŠ¥å‘Šæ—¶æ·»åŠ 

#### ç¯å¢ƒå˜é‡
æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ï¼š
```makefile
DB_URL ?= $(shell echo $$DB_URL)
API_KEY ?= $(shell echo $$API_KEY)
```

---

## 14. å‚è€ƒèµ„æº

- [Go å®˜æ–¹ä»£ç è§„èŒƒ](https://golang.org/doc/effective_go)
- [go-zero å®˜æ–¹æ–‡æ¡£](https://go-zero.dev/)
- [Uber Go ä»£ç è§„èŒƒ](https://github.com/uber-go/guide)
- [Google Go ä»£ç è§„èŒƒ](https://google.github.io/styleguide/go/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¶é—´**: 2025-12-02
**ç»´æŠ¤è€…**: AI Avatar Team
