 🎭 Me2 AI分身系统 - 服务关系与流程详解

  一、服务概览

  1. Avatar Service (分身服务)

  核心职责: 分身的基础数据管理
  - 存储分身的基本信息（昵称、头像、年龄等）
  - 管理分身的六维人格特征：
    - warmth (情绪温度): 0-100
    - adventurous (冒险倾向): 0-100
    - social (人际能量): 0-100
    - creative (创造性): 0-100
    - calm (情绪稳定性): 0-100
    - energetic (生活动力): 0-100
  - 提供分身信息查询接口

  数据库: avatars 表，personalities 表

  ---
  2. World Service (世界服务)

  核心职责: 虚拟世界的场景管理
  - 管理各种场景/地点（咖啡厅、公园、图书馆等）
  - 场景分类：exploration, social, study, creative, rest, play
  - 为不同行为类型推荐合适的场景
  - 提供场景详细信息（名称、描述、类别）

  数据库: scenes 表

  ---
  3. Scheduler Service (调度服务)

  核心职责: 定时触发分身行为
  - 定时扫描: 每 60 秒扫描一次数据库
  - 查找待调度: 找出 next_schedule_time <= now 且状态为 active 的分身
  - 调用 Action Service: 触发分身执行行为
  - 计算下次调度时间: 随机在 2-6 小时后
  - 失败重试: 失败后 5 分钟重试，连续失败 5 次自动暂停

  数据库: avatar_schedules 表

  ---
  4. Action Service (行动逻辑服务)

  核心职责: 决定分身做什么行为
  - 意图计算: 基于人格特征和时间因素，计算 6 种行为的意图得分
    - exploration (探索)
    - social (社交)
    - study (学习)
    - creative (创作)
    - rest (休息)
    - play (娱乐)
  - 选择行为: 选择得分最高的行为类型
  - 推荐场景: 调用 World Service 推荐合适的场景
  - 记录日志: 保存行动记录
  - 生成事件: 调用 Event Service 生成个性化事件（已集成）
  - 更新关联: 更新行动日志的 event_id 字段

  数据库: action_logs 表

  ---
  5. Event Service (事件服务)

  核心职责: 将行为转化为具体的故事
  - 接收行为: 从 Action Service 接收行为类型和场景
  - 选择模板: 根据行为类型选择事件模板
  - 调用 AI: 基于分身性格和场景，生成个性化事件内容
    - 调用 Avatar Service 获取分身信息
    - 调用 World Service 获取场景详情
    - 调用 AI Service 生成故事文本
  - 保存历史: 存储生成的事件

  数据库: events_history 表，event_templates 表

  ---
  二、完整工作流程

  ┌──────────────────────────────────────────────────────────────────┐
  │                    完整的自动化流程                                 │
  └──────────────────────────────────────────────────────────────────┘

  1️⃣ 【Scheduler Service 定时触发】
     │
     ├─ 每 60 秒扫描一次 `avatar_schedules` 表
     ├─ 查询条件: next_schedule_time <= now AND status = 'active'
     └─ 找到需要调度的分身 (avatar_id: 4947066875)
     │
     ▼

  2️⃣ 【调用 Action Service】
     │
     Scheduler → Action.ScheduleAction(avatar_id)
     │
     ▼

  3️⃣ 【Action Service 计算意图】
     │
     ├─ 调用 Avatar Service 获取分身信息和人格特征
     │  Avatar → GetAvatarInfo(avatar_id)
     │  返回: {warmth:50, adventurous:65, social:55, creative:60, calm:60, energetic:70}
     │
     ├─ 计算意图得分（内部逻辑）
     │  基于人格特征和时间因素计算各行为得分
     │  返回各行为得分:
     │  {
     │    exploration: 75,  ← 得分最高
     │    social: 68,
     │    study: 52,
     │    creative: 61,
     │    rest: 45,
     │    play: 58
     │  }
     │
     ├─ 选择得分最高的行为: exploration
     │
     ├─ 调用 World Service 推荐场景
     │  World → GetScenesForAction(action_type: "exploration")
     │  返回: {scene_id: 1, scene_name: "星巴克咖啡厅"}
     │
     ├─ 记录行动日志到 action_logs 表
     │  获得 action_id
     │
     └─ 返回: {action_type: "exploration", scene_id: 1, action_id: 123}
     │
     ▼

  4️⃣ 【调用 Event Service 生成事件】（已集成）
     │
     Action → Event.GenerateEvent(avatar_id, action_type, scene_id)
     │
     ▼

  5️⃣ 【Event Service 生成故事】
     │
     ├─ 调用 Avatar Service 获取分身信息
     │  Avatar → GetAvatarInfo(avatar_id)
     │  返回: {nickname: "小明", personality: {...}}
     │
     ├─ 调用 World Service 获取场景详情
     │  World → GetScene(scene_id: 1)
     │  返回: {name: "星巴克咖啡厅", description: "舒适的咖啡厅..."}
     │
     ├─ 查询事件模板
     │  从 event_templates 表查询 category = "exploration" 的模板
     │
     ├─ 调用 AI Service 生成故事
     │  AI → Generate(prompt_template: "event_generation", variables: {
     │    avatar_name: "小明",
     │    scene_name: "星巴克咖啡厅",
     │    action_type: "exploration",
     │    warmth: 50, adventurous: 65, ...
     │  })
     │  返回: {
     │    title: "咖啡厅里的神秘笔记本",
     │    content: "小明在星巴克角落发现了一本被遗忘的笔记本..."
     │  }
     │
     ├─ 保存事件到 events_history 表
     │
     └─ 返回: {event_id: 3, event_title: "...", event_text: "..."}
     │
     ▼

  6️⃣ 【Action Service 更新关联】（已集成）
     │
     └─ 更新 action_logs 表:
        - 将 event_id = 3 更新到对应的行动记录
     │
     ▼

  7️⃣ 【Scheduler 更新调度】
     │
     └─ 更新 avatar_schedules 表:
        - last_schedule_time = now
        - next_schedule_time = now + random(2-6 hours)
        - schedule_count += 1
        - failed_count = 0

  ---
  三、数据流向图

  ┌─────────────┐
  │   User      │ 创建分身
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │   Avatar    │ ← 所有服务都需要查询分身信息
  │   Service   │
  └─────────────┘
         ▲
         │
         │  获取人格特征
         │
  ┌─────────────┐     定时触发      ┌─────────────┐
  │  Scheduler  │ ──────────────→ │   Action    │
  │   Service   │                  │   Service   │
  └─────────────┘                  └──────┬──────┘
                                          │
                                          │  ① 计算意图
                                          │  ② 选择行为
                                          │  ③ 推荐场景
                                          │  ④ 调用事件服务
                                          │
                                          ▼
                          ┌───────────────────────────┐
                          │                           │
                     ┌────▼────┐               ┌──────▼──────┐
                     │  World  │               │    Event    │
                     │ Service │               │   Service   │
                     └─────────┘               └──────┬──────┘
                          △                           │
                          │                           │
                          └───────────────────────────┘
                                获取场景详情
                                      │
                                      ▼
                                ┌─────────┐
                                │   AI    │
                                │ Service │
                                └─────────┘
                                  生成故事

  ---
  四、关键设计理念

  1. 分层架构

  - Avatar: 数据层 - 存储基础信息
  - World: 数据层 - 存储场景信息
  - Action: 逻辑层 - 行为决策
  - Event: 内容层 - 内容生成
  - Scheduler: 调度层 - 自动化触发

  2. 微服务化

  - 每个服务独立部署、独立数据库
  - 通过 gRPC + Etcd 实现服务发现和调用
  - 服务之间低耦合、高内聚

  3. AI驱动

  - 意图计算: AI 根据人格特征决定行为
  - 内容生成: AI 根据性格和场景生成个性化故事
  - 自然变化: 人格特征随事件变化（待实现）

  4. 自动化运行

  - Scheduler 自动定时触发
  - 无需人工干预，分身自主"生活"
  - 2-6 小时随机间隔，模拟真实生活节奏

  ---
  五、典型使用场景

  场景 1: 分身自动行动（当前实现）

  用户创建分身 → Scheduler 自动调度 → Action 决定行为 → Event 生成事件 → 记录日志

  场景 2: 完整的事件生成流程（已实现并集成）

  Scheduler 触发 → Action 选择行为 → Event 生成故事 → 更新关联 → 用户查看时间线

  场景 3: 未来扩展

  Event 生成 → 影响人格特征 → 下次行为意图改变 → 形成成长曲线

  ---
  六、当前状态总结

  ✅ 已实现:
  - Avatar、World、Action、Scheduler、Event 服务独立可用
  - Scheduler → Action 自动调度流程
  - Event Service 可以生成个性化事件（通过 AI）
  - Action → Event 完整集成（自动生成事件并更新关联）
  - 完整的自动化流程：调度 → 行为决策 → 事件生成

  ⏸ 待集成:
  - Event 对人格特征的影响反馈
  - 用户查看分身事件时间线的前端 API
  - 分身成长曲线和人格变化追踪

  🎯 核心价值:
  整个系统实现了一个"自主的 AI 分身"，它有自己的性格，会根据性格做出不同的行为选择，在虚拟世界中"生活"，并通过 AI 生成各种个性化的故事。每次行动都会自动产生独特的事件内容，形成完整的生活时间线。