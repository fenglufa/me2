# Event 对人格特征的影响反馈 - 设计方案

## 一、方案概述

**选定方案**: 方案 1 - 基于模板的固定影响

**核心思路**:
- 每个事件模板预定义对六维人格的影响值
- Event Service 生成事件后，自动调用 Avatar Service 更新人格
- 记录人格变化历史，支持成长曲线可视化

## 二、技术实现

### 2.1 数据库设计

#### event_templates 表更新
```sql
-- 添加人格影响字段
ALTER TABLE event_templates
ADD COLUMN personality_impact JSON COMMENT '人格影响 {warmth:0, adventurous:2, ...}';
```

#### 新建 personality_history 表
```sql
CREATE TABLE `personality_history` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `avatar_id` bigint NOT NULL COMMENT '分身ID',
  `event_id` bigint NOT NULL COMMENT '触发事件ID',
  `changes` JSON NOT NULL COMMENT '人格变化值',
  `before_values` JSON NOT NULL COMMENT '变化前的人格值',
  `after_values` JSON NOT NULL COMMENT '变化后的人格值',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_avatar_id` (`avatar_id`),
  KEY `idx_event_id` (`event_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='人格变化历史表';
```

### 2.2 事件类型与人格维度映射

| 事件类型 | warmth | adventurous | social | creative | calm | energetic |
|---------|--------|-------------|--------|----------|------|-----------|
| exploration | 0 | +3 | 0 | +1 | -1 | +2 |
| social | +2 | 0 | +3 | 0 | 0 | +1 |
| study | 0 | 0 | -1 | +2 | +3 | 0 |
| creative | +1 | +1 | 0 | +4 | 0 | +1 |
| rest | +1 | -2 | -1 | 0 | +4 | -2 |
| play | +1 | +2 | +2 | +1 | -1 | +3 |

**设计理念**:
- 正值表示增强该维度，负值表示减弱
- 每个事件主要影响 2-3 个核心维度
- 影响值范围: -2 到 +4（适中速度）

### 2.3 实现流程

```
1. Event Service 生成事件
   ↓
2. 从模板读取 personality_impact
   ↓
3. 保存到 events_history.personality_changes
   ↓
4. 调用 Avatar Service.UpdatePersonality
   ↓
5. Avatar Service 应用人格变化
   - 读取当前人格值
   - 应用变化（累加）
   - 限制范围 0-100
   - 保存新值
   ↓
6. 记录到 personality_history 表
```

## 三、服务改造

### 3.1 Event Service 改造

**文件**: `services/event/rpc/internal/logic/generate_event_logic.go`

**改动点**:
1. 保存事件时读取模板的 `personality_impact`
2. 将影响值保存到 `events_history.personality_changes`
3. 调用 Avatar Service 的 `UpdatePersonality` 接口
4. 处理错误（失败不影响事件生成）

### 3.2 Avatar Service 改造

**新增 RPC 方法**: `UpdatePersonality`

**功能**:
1. 接收人格变化值（JSON）
2. 读取当前人格特征
3. 应用变化并限制范围
4. 更新 personalities 表
5. 记录变化历史到 personality_history 表

**Proto 定义**:
```protobuf
message UpdatePersonalityRequest {
  int64 avatar_id = 1;
  int64 event_id = 2;
  string personality_changes = 3; // JSON 格式
}

message UpdatePersonalityResponse {
  Personality before = 1;  // 变化前
  Personality after = 2;   // 变化后
}
```

### 3.3 数据模型新增

**Event Service**:
- 无需新增 Model（复用现有）

**Avatar Service**:
- 新增 `PersonalityHistoryModel`
- 实现 Insert、FindByAvatarId 等方法

## 四、配置更新

### Event Service 配置
无需额外配置（已有 AvatarRpc 配置）

## 五、实现优先级

### Phase 1 (MVP) - 当前实现
1. ✅ 数据库表结构创建
2. ✅ 模板数据初始化（添加 personality_impact）
3. ✅ Event Service 调用 Avatar Service
4. ✅ Avatar Service UpdatePersonality 实现
5. ✅ personality_history 记录

### Phase 2 (未来优化)
- 人格稳定性机制（随年龄增长变化减缓）
- 前端成长曲线可视化
- 人格变化统计分析
- AI 动态调整影响值（重要事件）

## 六、注意事项

1. **边界保护**: 人格值必须限制在 0-100 范围
2. **幂等性**: 同一个事件不应重复影响人格
3. **错误处理**: Avatar Service 更新失败不应影响事件生成
4. **性能**: 人格更新是同步操作，需要控制超时
5. **数据一致性**: personality_changes 字段应与实际应用的变化一致

## 七、测试场景

1. **正常流程**: 事件生成 → 人格更新 → 历史记录
2. **边界测试**: 人格值达到 0 或 100 时的行为
3. **失败场景**: Avatar Service 不可用时的降级
4. **并发测试**: 同一分身同时产生多个事件
5. **数据验证**: personality_history 记录完整准确

## 八、示例数据

### event_templates 示例
```json
{
  "id": 1,
  "category": "exploration",
  "title": "探索咖啡厅",
  "description": "...",
  "personality_impact": {
    "warmth": 0,
    "adventurous": 3,
    "social": 0,
    "creative": 1,
    "calm": -1,
    "energetic": 2
  }
}
```

### personality_history 示例
```json
{
  "id": 1,
  "avatar_id": 4947066875,
  "event_id": 123,
  "changes": {
    "warmth": 0,
    "adventurous": 3,
    "social": 0,
    "creative": 1,
    "calm": -1,
    "energetic": 2
  },
  "before_values": {
    "warmth": 50,
    "adventurous": 65,
    "social": 55,
    "creative": 60,
    "calm": 60,
    "energetic": 70
  },
  "after_values": {
    "warmth": 50,
    "adventurous": 68,
    "social": 55,
    "creative": 61,
    "calm": 59,
    "energetic": 72
  },
  "created_at": "2025-12-04 14:30:00"
}
```

## 九、监控指标

1. 人格更新成功率
2. 人格更新平均耗时
3. 各维度变化幅度统计
4. 异常变化告警（单次变化过大）
