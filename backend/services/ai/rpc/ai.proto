syntax = "proto3";

package ai;
option go_package = "./ai";

// AI 统一服务
service Ai {
  // 对话生成（非流式）
  rpc Chat(ChatRequest) returns (ChatResponse);

  // 对话生成（流式）
  rpc ChatStream(ChatRequest) returns (stream ChatStreamResponse);

  // 文本生成（事件、日记等）
  rpc Generate(GenerateRequest) returns (GenerateResponse);

  // 情绪分析
  rpc AnalyzeEmotion(AnalyzeEmotionRequest) returns (AnalyzeEmotionResponse);

  // 文本向量化
  rpc Embedding(EmbeddingRequest) returns (EmbeddingResponse);

  // 行动意图计算（供 Action Service 调用）
  rpc CalculateActionIntent(ActionIntentRequest) returns (ActionIntentResponse);

  // 获取 Prompt 模板列表
  rpc GetPrompts(GetPromptsRequest) returns (GetPromptsResponse);

  // 获取使用统计
  rpc GetStats(GetStatsRequest) returns (GetStatsResponse);

  // 健康检查
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

// 对话请求
message ChatRequest {
  string prompt_template = 1;  // Prompt 模板名称
  map<string, string> variables = 2;  // 变量
  ModelConfig model_config = 3;  // 模型配置
  int64 user_id = 4;  // 用户ID（用于统计）
  int64 avatar_id = 5;  // 分身ID（用于统计）
}

// 对话响应
message ChatResponse {
  string content = 1;  // 生成的内容
  int32 input_tokens = 2;  // 输入 token 数
  int32 output_tokens = 3;  // 输出 token 数
  int64 duration_ms = 4;  // 响应时间（毫秒）
}

// 文本生成请求
message GenerateRequest {
  string prompt_template = 1;  // Prompt 模板名称
  map<string, string> variables = 2;  // 变量
  ModelConfig model_config = 3;  // 模型配置
  int64 user_id = 4;
  int64 avatar_id = 5;
}

// 文本生成响应
message GenerateResponse {
  string content = 1;
  int32 input_tokens = 2;
  int32 output_tokens = 3;
  int64 duration_ms = 4;
}

// 情绪分析请求
message AnalyzeEmotionRequest {
  string text = 1;  // 要分析的文本
  int64 user_id = 2;
}

// 情绪分析响应
message AnalyzeEmotionResponse {
  string emotion = 1;  // 情绪类型（happy/sad/angry/neutral等）
  float score = 2;  // 情绪强度 0-1
  string analysis = 3;  // 分析说明
}

// 向量化请求
message EmbeddingRequest {
  string text = 1;  // 要向量化的文本
}

// 向量化响应
message EmbeddingResponse {
  repeated float vector = 1;  // 向量
  int32 dimension = 2;  // 维度
}

// 统计请求
message GetStatsRequest {
  int64 user_id = 1;  // 用户ID（0表示全部）
  string start_date = 2;  // 开始日期 YYYY-MM-DD
  string end_date = 3;  // 结束日期 YYYY-MM-DD
}

// 统计响应
message GetStatsResponse {
  int64 total_calls = 1;  // 总调用次数
  int64 total_input_tokens = 2;  // 总输入 token
  int64 total_output_tokens = 3;  // 总输出 token
  int64 total_cost = 4;  // 总成本（分）
  int64 success_calls = 5;  // 成功调用次数
  int64 error_calls = 6;  // 失败调用次数
  int64 avg_duration_ms = 7;  // 平均响应时间
}

// 模型配置
message ModelConfig {
  float temperature = 1;  // 温度 0-2
  int32 max_tokens = 2;  // 最大 token 数
  float top_p = 3;  // Top P
}

// 流式对话响应（流式返回，每次一小块内容）
message ChatStreamResponse {
  string content = 1;  // 本次返回的内容片段
  bool done = 2;  // 是否已完成
  int32 input_tokens = 3;  // 输入 token 数（最后一条消息中返回）
  int32 output_tokens = 4;  // 输出 token 数（最后一条消息中返回）
  int64 duration_ms = 5;  // 响应时间（最后一条消息中返回）
}

// 行动意图计算请求
message ActionIntentRequest {
  int64 avatar_id = 1;  // 分身ID

  // 分身人格向量（6维）
  PersonalityVector personality = 2;

  // 时间上下文
  TimeContext time_context = 3;

  // 最近用户互动事件
  repeated string recent_interactions = 4;

  // 最近发生的事件
  repeated string recent_events = 5;

  // 当前状态
  AvatarState current_state = 6;
}

// 行动意图计算响应
message ActionIntentResponse {
  // 各行为类别的得分（0-100）
  map<string, float> action_scores = 1;  // key: exploration/social/study/creative/rest/play/respond

  // 推荐的行为类型
  string recommended_action = 2;

  // 推荐理由
  string reason = 3;

  // 消耗 token 统计
  int32 input_tokens = 4;
  int32 output_tokens = 5;
}

// 人格向量
message PersonalityVector {
  int32 warmth = 1;  // 情绪温度 0-100
  int32 adventurous = 2;  // 冒险倾向 0-100
  int32 social = 3;  // 人际能量 0-100
  int32 creative = 4;  // 创造性 0-100
  int32 calm = 5;  // 情绪稳定性 0-100
  int32 energetic = 6;  // 生活动力 0-100
}

// 时间上下文
message TimeContext {
  string current_time = 1;  // 当前时间 HH:MM
  string time_period = 2;  // 时间段 morning/afternoon/evening/night
  string day_of_week = 3;  // 星期几
}

// 分身当前状态
message AvatarState {
  int32 energy = 1;  // 能量值 0-100
  string emotion_state = 2;  // 情绪状态
  string mood = 3;  // 心境
}

// 获取 Prompt 模板列表请求
message GetPromptsRequest {
  // 可选：按场景类型过滤
  string scene_type = 1;  // avatar_chat/event_story/avatar_diary/emotion_analysis 等
}

// 获取 Prompt 模板列表响应
message GetPromptsResponse {
  repeated PromptTemplate templates = 1;
}

// Prompt 模板
message PromptTemplate {
  string name = 1;
  string description = 2;
  string scene_type = 3;
  repeated string variables = 4;  // 需要的变量列表
}

// 健康检查请求
message HealthCheckRequest {
  // 空
}

// 健康检查响应
message HealthCheckResponse {
  string status = 1;  // ok/error
  string version = 2;  // 服务版本
  int64 uptime_seconds = 3;  // 运行时长（秒）
  bool deepseek_available = 4;  // Deepseek API 是否可用
  bool redis_available = 5;  // Redis 是否可用
  bool db_available = 6;  // 数据库是否可用
}

