# 服务启动指南

## 前置条件

### 1. 启动 Etcd

**重要**: 所有服务都需要 Etcd 进行服务注册和发现。

**macOS (使用 Homebrew)**:
```bash
# 安装 Etcd
brew install etcd

# 启动 Etcd
brew services start etcd

# 或临时启动
etcd
```

**Linux**:
```bash
# Ubuntu/Debian
sudo apt-get install etcd

# CentOS/RHEL
sudo yum install etcd
```

**Docker**:
```bash
docker run -d \
  --name etcd \
  -p 2379:2379 \
  -p 2380:2380 \
  -e ALLOW_NONE_AUTHENTICATION=yes \
  bitnami/etcd:latest
```

**验证 Etcd**:
```bash
etcdctl version
etcdctl endpoint health
```

### 2. 启动 Redis

SMS 服务需要 Redis 存储验证码。

**macOS (使用 Homebrew)**:
```bash
# 安装 Redis
brew install redis

# 启动 Redis
brew services start redis

# 或临时启动
redis-server
```

**Linux**:
```bash
# Ubuntu/Debian
sudo apt-get install redis-server
sudo systemctl start redis

# CentOS/RHEL
sudo yum install redis
sudo systemctl start redis
```

**验证 Redis**:
```bash
redis-cli ping
# 应该返回: PONG
```

### 2. 配置阿里云凭证

#### SMS 服务

复制环境变量模板并配置：
```bash
cd services/sms
cp .env.example .env
# 编辑 .env 文件，填入真实的阿里云凭证
```

需要设置的环境变量：
- `ALIYUN_ACCESS_KEY_ID`: 阿里云 AccessKey ID
- `ALIYUN_ACCESS_KEY_SECRET`: 阿里云 AccessKey Secret
- `ALIYUN_SMS_SIGN_NAME`: 短信签名
- `ALIYUN_SMS_TEMPLATE_CODE`: 短信模板代码

#### OSS 服务

```bash
cd services/oss
cp .env.example .env
# 编辑 .env 文件，填入真实的阿里云凭证
```

需要设置的环境变量：
- `ALIYUN_ACCESS_KEY_ID`: 阿里云 AccessKey ID
- `ALIYUN_ACCESS_KEY_SECRET`: 阿里云 AccessKey Secret
- `ALIYUN_OSS_ENDPOINT`: OSS Endpoint (如: oss-cn-hangzhou.aliyuncs.com)
- `ALIYUN_OSS_BUCKET_NAME`: OSS Bucket 名称

### 3. 加载环境变量

```bash
# 方式 1: 使用 source 命令
source .env

# 方式 2: 使用 export 命令
export $(cat .env | xargs)

# 方式 3: 使用 direnv (推荐)
# 安装 direnv
brew install direnv  # macOS
# 然后在 shell 配置文件中添加: eval "$(direnv hook zsh)"
# 重启终端，cd 到项目目录会自动加载
```

## 启动服务

### SMS 服务

```bash
cd services/sms

# 开发模式（使用开发配置，无需真实阿里云凭证）
make run-dev

# 生产模式（需要设置环境变量）
source .env
make run

# 或直接运行
cd rpc && go run .

# 或编译后运行
make build
./bin/sms-rpc
```

启动成功后会显示：
```
Starting sms rpc server at 0.0.0.0:8001...
```

### OSS 服务

```bash
cd services/oss

# 开发模式（使用开发配置，无需真实阿里云凭证）
make run-dev

# 生产模式（需要设置环境变量）
source .env
make run
```

启动成功后会显示：
```
Starting oss rpc server at 0.0.0.0:8002...
```

## 查看服务注册状态

使用 etcd-manager 脚本查看服务注册状态：

```bash
# 列出所有已注册的服务
./scripts/etcd-manager.sh list

# 查看指定服务详情
./scripts/etcd-manager.sh show sms.rpc
./scripts/etcd-manager.sh show oss.rpc

# 监控服务注册变化
./scripts/etcd-manager.sh watch

# 清理离线服务
./scripts/etcd-manager.sh cleanup
```

示例输出：
```
=== 已注册的服务 ===

服务名称: sms.rpc
实例数量: 1
服务地址:
  [1] 192.168.3.36:8001

服务名称: oss.rpc
实例数量: 1
服务地址:
  [1] 192.168.3.36:8002
```

## 测试服务

### 使用 grpcurl 测试

安装 grpcurl:
```bash
# macOS
brew install grpcurl

# Go install
go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
```

#### 测试 SMS 服务

```bash
# 查看服务列表
grpcurl -plaintext localhost:8001 list

# 查看 SMS 服务方法
grpcurl -plaintext localhost:8001 list sms.Sms

# 发送验证码
grpcurl -plaintext -d '{
  "phone": "13800138000",
  "scene": "login"
}' localhost:8001 sms.Sms/SendCode

# 验证验证码
grpcurl -plaintext -d '{
  "phone": "13800138000",
  "code": "123456"
}' localhost:8001 sms.Sms/VerifyCode
```

#### 测试 OSS 服务

```bash
# 查看服务方法
grpcurl -plaintext localhost:8002 list oss.Oss

# 获取上传 URL
grpcurl -plaintext -d '{
  "file_name": "avatar.jpg",
  "file_type": "avatar",
  "user_id": 1
}' localhost:8002 oss.Oss/GetUploadUrl

# 获取下载 URL
grpcurl -plaintext -d '{
  "file_key": "avatar/1/xxx.jpg"
}' localhost:8002 oss.Oss/GetDownloadUrl

# 删除文件
grpcurl -plaintext -d '{
  "file_key": "avatar/1/xxx.jpg"
}' localhost:8002 oss.Oss/DeleteFile
```

## 常见问题

### 1. Etcd 连接失败

**错误**:
```
context deadline exceeded
dial tcp 127.0.0.1:2379: connect: connection refused
```

**解决**:
```bash
# 检查 Etcd 是否运行
etcdctl endpoint health

# 如果没有运行，启动 Etcd
brew services start etcd  # macOS
sudo systemctl start etcd  # Linux

# 或使用 Docker
docker start etcd

# 验证连接
etcdctl get "" --prefix --keys-only
```

### 2. Redis 连接失败

**错误**:
```
dial tcp 127.0.0.1:6379: connect: connection refused
```

**解决**:
```bash
# 检查 Redis 是否运行
redis-cli ping

# 如果没有运行，启动 Redis
brew services start redis  # macOS
sudo systemctl start redis  # Linux
```

### 3. 环境变量未设置

**错误**:
```
config file etc/sms.yaml, value of Aliyun.AccessKeyId must be set
```

**解决**:
```bash
# 使用开发模式（无需真实凭证）
make run-dev

# 或检查环境变量
echo $ALIYUN_ACCESS_KEY_ID

# 如果为空，加载环境变量
source .env
# 或
export $(cat .env | xargs)
```

### 4. 阿里云凭证错误

**错误**:
```
InvalidAccessKeyId: The AccessKey ID provided does not exist in our records
```

**解决**:
- 检查 AccessKey ID 和 Secret 是否正确
- 确认 AccessKey 是否已启用
- 检查 AccessKey 是否有对应服务的权限

### 5. 端口已被占用

**错误**:
```
bind: address already in use
```

**解决**:
```bash
# 查找占用端口的进程
lsof -i :8001  # SMS 服务
lsof -i :8002  # OSS 服务

# 杀死进程
kill -9 <PID>

# 或修改配置文件中的端口
vim rpc/etc/sms.yaml
# 修改 ListenOn: 0.0.0.0:8001 为其他端口
```

## 开发模式

### 热重载开发

使用 `air` 实现热重载：

```bash
# 安装 air
go install github.com/cosmtrek/air@latest

# 在服务目录下运行
cd services/sms/rpc
air
```

### 查看日志

服务日志默认输出到控制台。如果需要查看更详细的日志：

```bash
# 修改配置文件
vim rpc/etc/sms.yaml

# 将日志级别改为 debug
Log:
  Level: debug  # info -> debug
```

## 生产环境部署

### 1. 使用 Docker

```bash
# 构建镜像
cd services/sms
docker build -t sms-rpc:latest .

# 运行容器
docker run -d \
  --name sms-rpc \
  -p 8001:8001 \
  -e ALIYUN_ACCESS_KEY_ID=xxx \
  -e ALIYUN_ACCESS_KEY_SECRET=xxx \
  -e ALIYUN_SMS_SIGN_NAME=xxx \
  -e ALIYUN_SMS_TEMPLATE_CODE=xxx \
  -e REDIS_HOST=redis:6379 \
  sms-rpc:latest
```

### 2. 启用 Etcd 服务注册

如果需要服务注册和发现，取消配置文件中 Etcd 的注释：

```yaml
# rpc/etc/sms.yaml
Etcd:
  Hosts:
    - 127.0.0.1:2379
  Key: sms.rpc
```

确保 Etcd 已启动：
```bash
# 启动 Etcd
etcd

# 或使用 Docker
docker run -d \
  --name etcd \
  -p 2379:2379 \
  -p 2380:2380 \
  quay.io/coreos/etcd:latest
```

### 3. 健康检查

可以添加健康检查端点（需要在代码中实现）：

```bash
curl http://localhost:8001/health
```

## 监控和调试

### 查看服务状态

```bash
# 查看进程
ps aux | grep sms-rpc

# 查看端口监听
netstat -an | grep 8001
lsof -i :8001
```

### 使用 pprof 性能分析

go-zero 自带 pprof 支持，可以通过以下方式访问：

```bash
# 查看 goroutine
go tool pprof http://localhost:8001/debug/pprof/goroutine

# 查看堆内存
go tool pprof http://localhost:8001/debug/pprof/heap

# 查看 CPU profile
go tool pprof http://localhost:8001/debug/pprof/profile
```

## 停止服务

```bash
# Ctrl+C 停止前台运行的服务

# 或找到进程并杀死
ps aux | grep sms-rpc
kill <PID>
```
